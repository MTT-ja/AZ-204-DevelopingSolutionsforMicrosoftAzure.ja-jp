---
lab:
    az204Title: 'ラボ 06: MSAL と .NET SDK を使用した Microsoft Graph の認証とクエリ'
    az020Title: 'ラボ 06: MSAL と .NET SDK を使用した Microsoft Graph の認証とクエリ'
    az204Module: 'モジュール 06: ユーザー認証と認可を実装する'
    az020Module: 'モジュール 06: ユーザー認証と認可を実装する'
---

# ラボ 06: OpenID Connect、MSAL、および .NET SDK を使用して認証する

## Microsoft Azure ユーザー インターフェイス

Microsoft クラウド ツールは頻繁に更新されるため、このトレーニング コンテンツ作成後に一部の Azure UI が変更されている可能性があります。その結果、ラボの手順やステップが、正しく整合しない可能性があります。

Microsoft では、コミュニティから変更の必要性を通知されたとき、トレーニング コースを更新しています。しかし、クラウドの更新は頻繁に行われているため、このトレーニング コースを更新する前に、UI の変更に気づく場合があります。**その場合は、変更に適宜対応して、ラボで要求されている内容を処理してください。**

## 手順

### 開始する前に

#### ラボ環境へのログイン

次の認証情報を使用して、Windows 10 仮想マシン (VM) にログインします。
    
-   ユーザー名: **Admin**

-   パスワード: **Pa55w.rd**

> **注**: 講師が仮想ラボ環境に接続するための手順を説明します。

#### インストールされているアプリケーションを確認します

Windows 10 デスクトップでタスク バーを探します。タスク バーには、以下をはじめとする、このラボで使用するアプリケーションのアイコンが含まれています。
    
-   Microsoft Edge

-   Visual Studio Code

## アーキテクチャの図

![OpenID Connect、MSAL、および .NET SDK を使用して認証するユーザーを示すアーキテクチャの図。](./media/Lab06-Diagram.png)

### 演習 1: シングル テナントの Azure AD 環境を構成する

#### タスク 1: Azure portal を開く

1.  タスク バーで、**Microsoft Edge** アイコンを選択します。

1.  開いたブラウザー ウィンドウで、Azure portal ([portal.azure.com](https://portal.azure.com)) を閲覧してから、このラボで使用するアカウントでログインします。

    > **注**: Azure portal に初めてログインする場合は、ポータルのツアーが表示されます。ツアーをスキップしてポータルの使用を開始するには、「**開始**」を選択します。

#### タスク 2: アプリケーションを Azure AD に登録する

1.  Azure portal で、「**リソース、サービス、およびドキュメントの検索**」テキスト ボックスを使用して「**Azure Active Directory**」を検索し、結果のリストで「**Azure Active Directory**」を選択します。

    > **注**: これにより、ブラウザー セッションが Azure サブスクリプションに関連付けられた Azure Active Directory (Azure AD) テナントのブレードにリダイレクトされます。

1.  「**Azure Active Directory**」ブレードで、「**管理**」セクションの「**アプリの登録**」を選択します。

1.  「**アプリの登録**」セクションで、「**+ 新規登録**」を選択します。

1.  「**アプリケーションを登録する**」セクションで、次のアクションを実行してから、「**登録**」を選択します。
    
    | 設定                          | アクション                                                       |
    | -------------------------------- | ------------------------------------------------------------ |
    | 「**名前**」テキスト ボックス                | 「**webappoidc**」と入力します。                                         |
    | 「**サポートされているアカウントの種類**」リスト | 「**この組織ディレクトリのみに含まれるアカウント (既定のディレクトリのみ - シングル テナント)**」を選択します。 |

   
    次のスクリーンショットは、「**アプリケーションを登録する**」セクションで構成された設定を示しています。
          
     ![アプリケーションを登録するために構成されたオプションを表示するスクリーンショット。](./media/l06_aad_register_st_webapp.png)
      
    
#### タスク 3: 一意の識別子を記録する

1.  **webappoidc** アプリケーションの「登録」ブレードで、「**概要**」を選択します。

1.  「**概要**」セクションで、「**アプリケーション (クライアント) ID**」テキスト ボックスの値を検索して記録します。この値は、このラボの後半で使用します。

1.  「**概要**」セクションで、「**ディレクトリ (テナント) ID**」テキスト ボックスの値を検索して記録します。この値は、このラボの後半で使用します。

#### タスク 4: アプリケーションの認証設定を構成する

1.  **webappoidc** アプリケーションの「登録」ブレードで、「**管理**」セクションの「**認証**」を選択します。

1.  「**認証**」セクションで、次のアクションを実行し、「**構成**」を選択します。

    | 設定                     | アクション                                                       |
    | --------------------------- | ------------------------------------------------------------ |
    | 「**プラットフォーム構成**」セクション      | 「**+ プラットフォームの追加**」を選択します。                    |
    | 「**プラットフォームの構成**」ブレード  | 「**Web**」を選択します。                                    |
    | 「**リダイレクト URI**」テキスト ボックス | `https://localhost:44321/` と入力します。                                      |
    | 「**フロント-チャネル ログアウト URL**」テキスト ボックス   | `https://localhost:44321/signout-oidc` と入力します。  |
        
1. 「**プラットフォーム構成**」セクションに戻り、「**URI の追加**」を選択してから、`https://localhost:44321/signin-oidc` と入力します。

1. 「**暗黙の付与とハイブリッド フロー**」セクションで、「**ID トークン (暗黙およびハイブリッド フローのために使用)**」を選択します。 

1. 「**保存**」を選択します。

    次のスクリーンショットは、「**認証**」ブレード上で構成された設定を示しています。
          
     ![認証ブレードで構成されたオプションを表示するスクリーンショット。](./media/l06_aad_autentication_webapp.png)
       

#### タスク 5: Azure AD ユーザーの作成

1.  Azure portal で、「**Cloud Shell**」アイコン ![Cloud Shell icon](./media/az204_lab_CloudShell.png) を選択して、新しい PowerShell セッションを開始します。Cloud Shell が既定の Bash セッションである場合は、**「Bash」** を選択してから、ドロップダウン メニューで、**「PowerShell」** を選択します。

     >**注**: 初めての **Cloud Shell** の起動であり、プロンプトが表示された場合は、**「Bash」** または **「PowerShell」** を選択して、**「PowerShell」** を選択します。**「ストレージがマウントされていません」** というメッセージが表示されたら、このラボで使用しているサブスクリプションを選択してから、**「ストレージの作成」** を選択します。

1.  「**Cloud Shell**」ペインで、次のコマンドを実行して、Azure サブスクリプションに関連付けられている Azure AD テナントにサインインします。

      ```powershell
       Connect-AzureAD
      ```

1.  次のコマンドを実行して、Azure AD テナントのプライマリ ドメイン名システム (DNS) のドメイン名を取得して表示します。

       ```powershell
       $aadDomainName = ((Get-AzureAdTenantDetail).VerifiedDomains)[0].Name
       $aadDomainName
       ```

    > **注**: DNS ドメイン名の値を記録します。この値は、このラボの後半で使用します。

1.  次のコマンドを実行して、Azure AD 認証のテストに使用する Azure AD ユーザーを作成します。

       ```powershell
       $passwordProfile = New-Object -TypeName Microsoft.Open.AzureAD.Model.PasswordProfile
       $passwordProfile.Password = 'Pa55w.rd1234'
       $passwordProfile.ForceChangePasswordNextLogin = $false
       New-AzureADUser -AccountEnabled $true -DisplayName 'aad_lab_user1' -PasswordProfile $passwordProfile -MailNickName 'aad_lab_user1' -UserPrincipalName "aad_lab_user1@$aadDomainName" 
       ```

1.  次のコマンドを実行して、新しく作成された Azure AD ユーザーのユーザー プリンシパル名 (UPN) を特定します。

       ```powershell
       (Get-AzureADUser -Filter "MailNickName eq 'aad_lab_user1'").UserPrincipalName
       ```

    > **注**: UPN を記録します。この値は、このラボの後半で使用します。

1.  「Cloud Shell」ペインを閉じます。

#### 確認

この演習では、シングルテナントの Azure AD アプリケーションを登録し、Azure AD ユーザー アカウントを作成しました。

### 演習 2: シングルテナントの ASP.NET Core Web アプリを作成する

#### タスク 1: ASP.NET Core Web アプリ プロジェクトを作成する

1.  ラボ コンピューターで、**コマンド プロンプト**を起動します。

1.  コマンド プロンプトから、次のコマンドを実行して、作業ディレクトリを作成し、**Allfiles (F):\\Allfiles\\Labs\\06\\Starter\\OIDCClientST** に設定します。

    ```powershell
    F:
    md "F:\Allfiles\Labs\06\Starter\OIDCClient"
    cd F:\Allfiles\Labs\06\Starter\OIDCClient
    ```

1.  次のコマンドを実行して、Model View Controller (MVC) テンプレートに基づいて新しい .NET Core Web アプリを作成します (プレースホルダー `<application_ID>`、`<tenant_ID>`、および `<domain_Name>` を、このラボで以前に記録した対応する値に置き換えます)。

    ```powershell
    dotnet new mvc --auth SingleOrg --client-id <application_ID> --tenant-id <tenant_ID> --domain <domain_Name>
    rmdir .\obj /S /Q
    ```

1.  ラボ コンピューターで、Visual Studio Code を起動します。

1.  「**ファイル**」メニューで、「**フォルダーを開く**」を選択します。

1.  「**ファイル エクスプローラー**」ウィンドウで、**Allfiles (F):\\Allfiles\\Labs\\06\\Starter\\OIDCClient** に移動し、「**フォルダーの選択**」を選択します。

1.  「Visual Studio Code **エクスプローラー**」ペインで、MVC Web アプリを表す自動生成されたフォルダー構造を確認します。

1.  **Properties** フォルダーに移動し、**launchSettings.json** ファイルを開いて、次の変更を適用します。

    
    | セクション         | プロパティ           | 値                                                   |
    | --------------- | ------------------ | ------------------------------------------------------- |
    | **iisSettings** | **sslPort**        | **44321**                                               |
    | **OIDCClient**  | **applicationUrl** | `https://localhost:44321` |
    

    > **注**: ポート番号は、Azure AD アプリの登録を作成するときに指定した値と一致する必要があります。

1.  ファイルを保存して閉じます。

1.  「Visual Studio Code **エクスプローラー**」ペインで、「**OIDCClient.csproj**」を選択します。

1.  `<TargetFramework>` 要素の値が **netcoreapp3.1** に設定されていることを確認します。

1.  `Microsoft.AspNetCore.Authentication.JwtBearer` および `Microsoft.AspNetCore.Authentication.OpenIdConnect` NuGet パッケージのバージョンを **3.1.18** に設定します。

1.  `Microsoft.Identity.Web` および `Microsoft.Identity.Web.UI` NuGet パッケージのバージョンを **0.3.1-preview** に設定します。

1.  `<WebProject_DirectoryAccessLevelKey>0</WebProject_DirectoryAccessLevelKey>` エントリを削除します。

1.  `<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="3.1.7" />` エントリを削除します。

1.  **OIDCClient.csproj** ファイルの内容が次のリストに似ていることを確認し (`UserSecretsId` の値は異なります)、変更を保存します。

    ```csharp
    <Project Sdk="Microsoft.NET.Sdk.Web">
      <PropertyGroup>
        <TargetFramework>netcoreapp3.1</TargetFramework>
        <UserSecretsId>aspnet-OIDCClient-737DEB13-25D4-4C52-93C5-F485367E3C8C</UserSecretsId>
      </PropertyGroup>

      <ItemGroup>
        <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="3.1.18" NoWarn="NU1605" />
        <PackageReference Include="Microsoft.AspNetCore.Authentication.OpenIdConnect" Version="3.1.18" NoWarn="NU1605" />
        <PackageReference Include="Microsoft.Identity.Web" Version="0.3.1-preview" />
        <PackageReference Include="Microsoft.Identity.Web.UI" Version="0.3.1-preview" />
      </ItemGroup>

    </Project>
    ```

1.  **OIDCClient.csproj** ファイルを閉じます。

1.  **Views\Shared** フォルダーに移動し、**_LoginPartial.cshtml** ファイルを開きます。

1.  次の行で、`AzureAD` を `MicrosoftIdentity` に置き換えます。

    ```csharp
    <a class="nav-link text-dark" asp-area="AzureAD" asp-controller="Account" asp-action="SignOut">Sign out</a>`
    ```

1.  次の行で、`AzureAD` を `MicrosoftIdentity` に置き換えます。

    ```csharp
    <a class="nav-link text-dark" asp-area="AzureAD" asp-controller="Account" asp-action="SignIn">Sign in</a>
    ```

1.  ファイルを保存して閉じます。

1.  ファイル **appsettings.json** を開き、次の要素を含む **AzureAd** オブジェクトのコンテンツを確認します。

    | 要素        | 値                                                        |
    | -------------- | ------------------------------------------------------------ |
    | `Instance`     | `https://login.microsoftonline.com/`                          |
    | `Domain`       | Azure サブスクリプションに関連付けられている Azure AD テナントのプライマリ DNS ドメイン。 |
    | `TenantId`     | Azure AD テナントの GUID。                                 |
    | `ClientId`     | アプリケーション (クライアント) Azure AD テナントに登録したアプリケーションの ID。 |
    | `CallbackPath` | `/signin-oidc`                                               |

1.  変更を加えずにファイルを閉じます。

1.  「Visual Studio Code **エクスプローラー**」ペインで、「**Startup.cs**」を選択します。

1.  `usingMicrosoft.AspNetCore.Authentication.AzureAD.UI;` ディレクティブを削除します。

1.  前の手順で削除したエントリの直後に、次の **using** ディレクティブを追加します。

    ```csharp
    using Microsoft.AspNetCore.Authentication.OpenIdConnect;
    using Microsoft.Identity.Web;
    using Microsoft.Identity.Web.UI;
    ```

1.  次の行を削除します。

    ```csharp
    services.AddAuthentication(AzureADDefaults.AuthenticationScheme)
      .AddAzureAD(options => Configuration.Bind("AzureAd", options));
    ```

1.  前の手順で削除した行を次の行に置き換えます。

    ```csharp
    services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)
      .AddMicrosoftIdentityWebApp(Configuration.GetSection("AzureAd"));
    ```

1.  次の行を削除します。

    ```csharp
    services.AddRazorPages();
    ```

1.  前の手順で削除した行を次の行に置き換えます。

    ```csharp
    services.AddRazorPages()
      .AddMicrosoftIdentityUI();
    ```

1.  ファイルを保存して閉じます。

### タスク 2: シングルテナント シナリオでシングルテナント Web アプリをテストする

1.  「**Visual Studio Code**」ウィンドウで、「**エクスプローラー**」ペインのショートカット メニューをアクティブ化してから、**「統合ターミナルで開く」** を選択します。

1.  次のコマンドを実行して、.NET Web アプリをビルドします。

    ```
    dotnet build
    ```

    > **注**: ビルド エラーがある場合は、**Allfiles (F):\\Allfiles\\Labs\\06\\Solution\\OIDCClient** フォルダーのファイルを確認してください。

1.  次のコマンドを実行して自己署名証明書を生成し、それを信頼するようにローカル コンピューターを構成します。

    ```
    dotnet dev-certs https --trust
    ```

1.  自動生成された証明書をインストールするように求められたら、「**はい**」を選択します。

1.  ターミナル プロンプトから、次のコマンドを実行して、.NET Web アプリを実行します。

    ```
    dotnet run
    ```

1.  Microsoft Edge ブラウザーを **InPrivate** モードで起動し、`https://localhost：44321` URLに移動します。

1.  「**接続はプライベートではありません**」メッセージが表示された場合は、「**詳細設定**」を選択し、「**ローカル ホストへの続行 (安全でない)**」リンクを選択します。

1.  開いているブラウザー ウィンドウで、プロンプトが表示されたら、このラボで以前に作成した **aad_lab_user1** Azure AD アカウントの UPN を使用して、**Pa55w.rd1234** をパスワードとして認証します。

1.  「**要求されたアクセス許可**」 Web ページがブラウザー ウィンドウに自動的に開かれます。

1.  要求されたアクセス許可を確認します。これには、**基本プロファイルの表示**と、**アクセスを許可したデータへのアクセスの維持**が含まれます。

1.  「**承認**」を選択します。

1.  ブラウザーに表示されるターゲット サイトの「**ようこそ** ホーム」ページを確認し、**aad_user1** Azure AD アカウントの UPN がブラウザー ウィンドウに表示されることを確認します。

1.  「**ようこそ**」ページで、「**サインイン**」を選択します。

1.  サインアウトするアカウントを選択するように求められたら、**aad_lab_user1** Azure AD アカウントを選択します。「**サインアウト済み**」ページに自動的にリダイレクトされます。

1.  「**サインアウト済み**」ページを表示する Microsoft Edge ブラウザーを開いたままにします。

#### 確認 

この演習では、シングルテナントの Web アプリを実装し、シングルテナントの Azure 環境でテストしました。

### 演習 3: マルチテナントの Azure AD 環境を構成する

#### タスク 1: Azure AD テナントを作成する

1.  Azure portal を表示する Microsoft Edge ブラウザーに切り替えます。

1.  Azure portal で、「**Azure Active Directory**」ブレードに移動します。

1.  「**Azure Active Directory**」ブレードで、「**テナントの管理**」を選択し、「**+ 作成**」を選択します。

1.  「**テナントの作成**」ブレードの「**基本**」タブで、オプション「**Azure Active Directory**」が選択されていることを確認し、「**次へ: 構成 >**」を選択します。

1.  「**テナントの作成**」ブレードの「**構成**」タブで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | 組織名 | **Contoso** |
    | 初期ドメイン名 | 小文字と数字で構成され、文字で始まる有効な DNS 名。 |
    | 国/地域 | あなたの国または地域の名前 |

1.  「**確認および作成**」を選択し、次に「**作成**」を選択します。

1.  プロンプトが表示されたら、「**あなたがロボットではないことを証明するのを手伝ってください**」で、提供されたコードを入力して、「**送信**」を選択します。

1.  プロビジョニングが完了するのを待ってから、「**Contoso**」リンクを選択して、Contoso Azure AD テナントのプロパティを表示するブレードに移動します。

1.  Azure AD テナントの「**概要**」ブレードで、***テナント ID** プロパティの値を特定して記録します。この値は、このラボの後半で使用します。

#### タスク 2: Azure AD ユーザーの作成

1.  Azure portal を表示している Web ブラウザーウィンドウで、「**Directory + Subscription**」ツールバー アイコンを選択します。

1.  「**ポータル設定 | Directory + Subscription**」ブレードで、サブスクリプションに関連付けられている Azure AD テナントを表すエントリの横にある「**切り替え**」を選択します。

1.  Azure potal で、「**Cloud Shell**」アイコンを選択して新しい PowerShell セッションを開きます。 

1.  「**Cloud Shell**」ペインで、次のコマンドを実行して Contoso Azure AD テナントにサインインします。`<tenant_Id>` プレースホルダーを、前のタスクで特定したテナント ID プロパティの値に置き換えます。

       ```powershell
       Import-Module AzureAD.Standard.Preview
       AzureAD.Standard.Preview\Connect-AzureAD -TenantID '<tenant_ID>'
       ```
1.  Ctrl キーを押しながら警告の URL をクリックしてブラウザー ウィンドウを開き、手順に従って認証します。  

1.  次のコマンドを実行して、Azure AD テナントの DNS ドメイン名を取得します。

       ```powershell
       $aadDomainName = ((Get-AzureAdTenantDetail).VerifiedDomains)[0].Name
       ```

1.  次のコマンドを実行して、Azure AD 認証のテストに使用する Azure AD ユーザーを作成します。

       ```powershell
       $passwordProfile = New-Object -TypeName Microsoft.Open.AzureAD.Model.PasswordProfile
       $passwordProfile.Password = 'Pa55w.rd1234'
       $passwordProfile.ForceChangePasswordNextLogin = $false
       New-AzureADUser -AccountEnabled $true -DisplayName 'aad_lab_user2' -PasswordProfile $passwordProfile -MailNickName 'aad_lab_user2' -UserPrincipalName "aad_lab_user2@$aadDomainName"
       ```

1.  次のコマンドを実行して、新しく作成された Azure AD ユーザーの UPN を特定します。

       ```powershell
       (Get-AzureADUser -Filter "MailNickName eq 'aad_lab_user2'").UserPrincipalName
       ```

    > **注**: UPN を記録します。この値は、このラボの後半で使用します。

1.  「**Cloud Shell**」ペインを閉じます。

### タスク 3: マルチテナント シナリオでシングルテナント Web アプリをテストする

1.  「**サインアウト済み**」ページが表示されている **InPrivate** モードの Microsoft Edge ブラウザーに戻り、「**サインイン**」を選択します。

1.  開いているブラウザー ウィンドウで、プロンプトが表示されたら、この演習で以前に作成した **aad_lab_user2** Azure AD アカウントの UPN を使用して、**Pa55w.rd1234** をパスワードとして認証します。

1.  使用したユーザー アカウントが **webappoidc** Web アプリが登録されているテナントに存在しないことを示すエラー メッセージに注意してください。

    > **注**: このシナリオでサインインを機能させるには、最初にこのアカウントを外部ユーザーとして webappoidc Web アプリ登録をホストしているテナントに追加する必要があります。

1.  エラー メッセージが表示されている Microsoft Edge ブラウザーを閉じてから、**Visual Studio Code** ウィンドウに戻ります。

1.  「**ターミナル**」ペインで、「**ターミナルの強制終了**」 (または「**ごみ箱**」アイコン) を選択して、現在開いているターミナルと関連するプロセスを閉じます。

#### 確認

この演習では、マルチテナントの Azure 環境を構成し、シングルテナントの Web アプリでテストしました。

### 演習 4: マルチテナント ASP.NET Core Web アプリを構成する

#### タスク 1: Azure AD でアプリケーション登録を構成する

1.  Azure portal に切り替えてから、「**Directories + Subscriptions**」ツールバー アイコンを選択します。

1.  「**ポータル設定 | Directory + Subscription**」ブレードで、サブスクリプションに関連付けられている Azure AD テナントを表すエントリの横にある「**切り替え**」を選択します。

1.  「**Azure Active Directory**」ブレードで、「**管理**」セクションの「**アプリの登録**」を選択します。

1.  アプリ登録のリストで、**「webappoidc」** を選択します。

1.  **webappoidc** アプリケーションの「登録」ブレードで、「**管理**」セクションの「**認証**」を選択します。

1.  「**サポートされているアカウントの種類**」で、「**任意の組織ディレクトリ内のアカウント (任意の Azure AD ディレクトリ - マルチテナント)**」を選択します。

1.  「**保存**」を選択します。

    次のスクリーンショットは、「**アプリ登録**」ブレード上で構成された設定を示しています。
          
     ![アプリ登録ブレードで構成されたオプションを表示するスクリーンショット。](./media/l06_aad_register_mt_webapp.png)

    
#### タスク 2: ASP.NET Core Web アプリのマルチテナンシー サポートを構成する

1.  ラボ コンピューターで、Visual Studio Code を起動します。

1.  **appsettings.json** ファイルを開きます。

1.  `TenantId` 要素を含む行を次の行に置き換えます。

    ```
    "TenantId": "organizations", 
    ```

1.  ファイルを保存して閉じます。

### タスク 3: マルチテナント シナリオでマルチテナント Web アプリをテストする

1.  「**Visual Studio Code**」ウィンドウで、「**エクスプローラー**」ペインのショートカット メニューをアクティブ化してから、**「統合ターミナルで開く」** を選択します。

1.  ターミナル プロンプトから、次のコマンドを実行して、.NET Web アプリを実行します。

    ```
    dotnet run
    ```

1.  Microsoft Edge ブラウザーを **InPrivate** モードで起動し、`https://localhost：44321` URLに移動します。

1.  「**接続はプライベートではありません**」メッセージが表示された場合は、「**詳細設定**」を選択し、「**ローカル ホストへの続行 (安全でない)**」リンクを選択します。

1.  開いているブラウザー ウィンドウで、プロンプトが表示されたら、このラボで以前に作成した **aad_lab_user1** Azure AD アカウントの UPN を使用して、**Pa55w.rd1234** をパスワードとして認証します。

1.  ブラウザーに表示されるターゲット サイトの「**ようこそ**ホーム」ページを確認し、**aad_lab_user1** Azure AD アカウントの UPN がブラウザー ウィンドウに表示されることを確認します。

1.  「**ようこそ**」ページで、「**サインイン**」を選択します。

1.  サインアウトするアカウントを選択するように求められたら、**aad_lab_user1** Azure AD アカウントを選択します。「**サインアウト済み**」ページに自動的にリダイレクトされます。

1.  「**サインアウト済み**」ページを表示する Microsoft Edge ブラウザーで、「**サインイン**」を選択します。

1.  開いているブラウザー ウィンドウで、プロンプトが表示されたら、この演習で以前に作成した **aad_lab_user2** Azure AD アカウントの UPN を使用して、**Pa55w.rd1234** をパスワードとして認証します。

1.  「**要求されたアクセス許可**」 Web ページがブラウザー ウィンドウに自動的に開かれます。

1.  要求されたアクセス許可を確認します。これには、**基本プロファイルの表示**と、**アクセスを許可したデータへのアクセスの維持**が含まれます。

1.  「**承認**」を選択します。

    > **注**: アプリケーションは未確認としてリストされています。このラボで使用しているサンプル アプリはパブリッシャーによる検証を受けていないため、これは予想されることです。詳細については、[パブリッシャーの検証](https://docs.microsoft.com/ja-jp/azure/active-directory/develop/publisher-verification-overview)について説明している Microsoft のドキュメントを参照してください。

1.  ブラウザーに表示されるターゲット サイトの「**ようこそ**ホーム」ページを確認し、**aad_lab_user2** Azure AD アカウントの UPN がブラウザー ウィンドウに表示されることを確認します。

1.  「**ようこそ**」ページで、「**サインイン**」を選択します。

1.  **InPrivate** モードで Microsoft Edge ブラウザーを閉じてから、**Visual Studio Code** ウィンドウに戻ります。

1.  「**ターミナル**」ペインで、「**ターミナルの強制終了**」 (または「**ごみ箱**」アイコン) を選択して、現在開いているターミナルと関連するプロセスを閉じます。

#### 確認

この演習では、マルチテナント Web アプリを実装し、マルチテナント Azure 環境でテストしました。

### 演習 5: サブスクリプションのクリーンアップ

#### タスク 1: Azure AD でのアプリケーションの登録の削除

1.  Azure portal を表示する Microsoft Edge ブラウザーに切り替えます。

1.  Azure portal で、Contoso Azure AD テナントのブレードに移動します。これにより、「**Contoso \| 概要**」ブレードが表示されます。

1.  「**Azure Active Directory**」ブレードで、「**管理**」セクションの「**エンタープライズ アプリケーション**」を選択します。

1.  「**エンタープライズ アプリケーション \| すべてのアプリケーション**」ブレードで、「**webappoidc**」を選択します。

1.  「**webappoidc \| 概要**」ブレードで、「**プロパティ**」を選択します。

1.  「**webappoidc \| プロパティ**」ブレードで、「**削除**」を選択し、確認を求められたら、「**はい**」を選択します。

1.  Contoso Azure AD テナントの「**ユーザー \| すべてのユーザー (プレビュー)**」ブレードに移動します。

1.  ユーザーの一覧で「**aad_lab_user2**」を選択します。

1.  「**aad_lab_user2 \| プロファイル**」ブレードで、「**削除**」を選択してから、確認を求められたら、「**はい**」を選択します。

1.  「**Contoso \| 概要**」ブレードに戻ってから、「**テナントの管理**」を選択します。

1.  テナントの一覧で、「**Contoso (既定)**」エントリの横のチェックボックスを選択してから、「**削除**」を選択します。

1.  「**テナント 'Contoso' を削除しますか?**」ブレードで、「**削除**」を選択します。

1.  必要に応じて、Azure AD テナントの「**プロパティ**」ブレード上の「**Azure リソースを削除するためのアクセス許可を取得する**」を選択し、「**Azure リソースのアクセス管理**」で、「**はい**」を選択してから、「**保存**」を選択します。

1.  「**テナント 'Contoso' を削除しますか?**」ブレードに戻り、ブラウザー ページを更新し、「**削除**」を選択してから、「**はい**」を選択して確認します。

1.  Azure portal で、Azure サブスクリプションに関連付けられている Azure AD テナントのブレードに戻ります。

1.  「**Azure Active Directory**」ブレードで、「**管理**」セクションの「**アプリの登録**」を選択します。

1.  「**アプリの登録**」セクションで、この課題で前に作成した **webappoidc** Azure AD アプリケーションの登録を選択します。

1.  「**webappoidc**」セクションで、次の操作を実行します:

    a. 「**削除**」を選択します。

    b. 「**アプリ登録の削除**」ブレードで、「**このアプリ登録を削除することの意味を理解しています**」を選択し、「**削除**」を選択します。

1.  「**ユーザー \| すべてのユーザー (プレビュー)**」ブレードに移動します。

1.  ユーザーの一覧で「**aad_lab_user1**」を選択します。

1.  「**aad_lab_user1 \| プロファイル**」ブレードで、「**削除**」を選択し、確認を求められたら、「**はい**」を選択します。

#### タスク 2: アクティブなアプリケーションを閉じる

1.  開いている Microsoft Edge ウィンドウを閉じます。

1.  Visual Studio Code を閉じます。

#### 確認

この実習では、この課題で使用する アプリケーションの登録を削除してサブスクリプションをクリーンアップしました。
